name: Reopen on External Comment

on:
  issue_comment:
    types: [created]

jobs:
  reopen:
    runs-on: ubuntu-latest
    if: github.event.issue.state == 'closed' && github.event_name == 'issue_comment' && github.event.issue.pull_request == null
    permissions:
      issues: write
    steps:
      - name: Reopen when commenter is outside replicatedhq
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            // Avoid bot loops
            if (commenter === 'replicated-collab-bot') {
              core.info('Commenter is replicated-collab-bot; skipping reopen');
              return;
            }
            // Check public org membership (204 => public member)
            let isReplicatedMember = false;
            try {
              const res = await github.rest.orgs.checkPublicMembershipForUser({
                org: 'replicatedhq',
                username: commenter,
              });
              isReplicatedMember = res.status === 204;
            } catch (e) {
              // Non-public members or not found -> treat as external
              core.info(`Membership check result: ${e.status || 'unknown'} (treating as external if not 204)`);
            }
            if (isReplicatedMember) {
              core.info('Commenter is a public member of replicatedhq; not reopening');
              return;
            }
            core.info('Commenter is external; reopening issue');
            try {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                state: 'open',
              });
            } catch (e) {
              core.info(`Failed to reopen issue: ${e.message}`);
              return;
            }
            // Remove all status::* labels only after successful reopen
            try {
              const existing = await github.paginate(
                github.rest.issues.listLabelsOnIssue,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  per_page: 100,
                }
              );
              const toRemove = existing
                .map(l => l.name)
                .filter(name => name.startsWith('status::'));
              for (const name of toRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.issue.number,
                    name,
                  });
                } catch (e) {
                  core.info(`Skipping removal of label ${name}: ${e.message}`);
                }
              }
            } catch (e) {
              core.info(`Failed to list labels: ${e.message}`);
            }

