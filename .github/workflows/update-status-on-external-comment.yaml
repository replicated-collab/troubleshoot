name: Update Status on External Comment

on:
  issue_comment:
    types: [created]

jobs:
  update-status:
    runs-on: ubuntu-latest
    if: github.event.issue.state == 'open' && github.event_name == 'issue_comment' && github.event.issue.pull_request == null
    permissions:
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Require replicatedhq member
        id: member
        uses: ./.github/actions/require-replicatedhq-member
        continue-on-error: true
      - name: Update status when commenter is outside replicatedhq
        if: steps.member.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            // Avoid bot loops
            if (commenter === 'replicated-collab-bot') {
              core.info('Commenter is replicated-collab-bot; skipping status update');
              return;
            }
            // Check if issue has status::pending or status::awaiting-confirmation label
            let labelsToRemove = [];
            try {
              const labels = await github.paginate(
                github.rest.issues.listLabelsOnIssue,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  per_page: 100,
                }
              );
              const labelNames = labels.map(l => l.name);
              if (labelNames.includes('status::pending')) {
                labelsToRemove.push('status::pending');
              }
              if (labelNames.includes('status::awaiting-confirmation')) {
                labelsToRemove.push('status::awaiting-confirmation');
              }
            } catch (e) {
              core.info(`Failed to list labels: ${e.message}`);
              return;
            }
            if (labelsToRemove.length === 0) {
              core.info('Issue does not have status::pending or status::awaiting-confirmation label; skipping status update');
              return;
            }
            core.info(`Commenter is external and issue has ${labelsToRemove.join(', ')}; updating status`);
            // Remove status::pending and/or status::awaiting-confirmation and add status::open
            for (const labelName of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  name: labelName,
                });
                core.info(`Removed ${labelName} label`);
              } catch (e) {
                core.info(`Failed to remove ${labelName} label: ${e.message}`);
                return;
              }
            }
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['status::open'],
              });
              core.info('Added status::open label');
            } catch (e) {
              core.info(`Failed to add status::open label: ${e.message}`);
            }

