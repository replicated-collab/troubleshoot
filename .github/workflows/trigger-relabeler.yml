name: Trigger Issue Relabeler on Close

on:
  issues:
    types: [closed]

jobs:
  trigger-relabeler:
    name: Trigger Relabeling in ce-automation
    runs-on: ubuntu-latest
    # Only process inbound escalations
    if: contains(github.event.issue.labels.*.name, 'kind::inbound-escalation')
    steps:
      - name: Prepare payload
        id: prepare
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueUrl = issue.html_url;
            const issueNumber = issue.number;
            const repo = context.repo.repo;
            const org = context.repo.owner;

            // Extract current product labels
            const productLabels = issue.labels
              .filter(label => label.name.startsWith('product::'))
              .map(label => label.name);

            console.log('Processing closed issue for relabeling:', {
              org,
              repo,
              issueNumber,
              issueUrl,
              currentProductLabels: productLabels
            });

            core.setOutput('issue_url', issueUrl);
            core.setOutput('issue_number', issueNumber);
            core.setOutput('repo_name', repo);
            core.setOutput('org_name', org);
            core.setOutput('current_labels', JSON.stringify(productLabels));

      - name: Trigger ce-automation relabeler workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CE_AUTOMATION_DISPATCH_TOKEN }}
          script: |
            const targetOwner = 'replicatedhq';
            const targetRepo = 'ce-automation';
            const workflowFileName = 'issue-relabeler-on-close.yml';

            const inputs = {
              issue_url: '${{ steps.prepare.outputs.issue_url }}',
              issue_number: '${{ steps.prepare.outputs.issue_number }}',
              repo_name: '${{ steps.prepare.outputs.repo_name }}',
              org_name: '${{ steps.prepare.outputs.org_name }}',
              current_labels: '${{ steps.prepare.outputs.current_labels }}'
            };

            console.log('Triggering relabeler with inputs:', inputs);

            await github.rest.actions.createWorkflowDispatch({
              owner: targetOwner,
              repo: targetRepo,
              workflow_id: workflowFileName,
              ref: 'main',
              inputs: inputs
            });

            console.log('Successfully triggered relabeler workflow');